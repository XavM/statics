# Satellite Deployment Procedure

## 1 : Check pre requisits exist

#### INFO : Some pre requisits are not created by argocd and need manual / external creation ; 

Ex: 
  - Satellites DBs : MongoDB, PostGreSQL
  - Keycloak realms 
  - Networking & Connectivity, includind FireWall ACLs

#####  Depency Matrix : 

|Component        |byAIO|byPDP|all|rabbitmq|activemq|mysql|mongo|postgres|S3 |NFS|mongo_AIO|postgres_AIO|
|-----------------|-----|-----|---|--------|--------|-----|-----|--------|---|---|---------|------------|
|AIO              |     |     |   |✓       |        |     |✓✓   |✓       |✓  |✓  |         |            |
|PPF Gateway      |     |✓    |   |✓       |        |     |     |✓       |✓  |✓  |         |            |
|Invoice API      |✓    |     |   |✓       |        |     |✓    |        |✓  |   |v5.96+   |v5.96+      |
|Event Generator  |✓    |     |   |✓       |        |     |✓    |        |   |   |         |✓           |
|Webhook          |     |✓    |   |✓       |        |     |✓    |        |   |   |         |            |
|Legal Ref        |     |✓    |   |        |        |     |     |✓       |   |   |         |            |
|keycloak         |     |     |   |        |        |     |     |        |   |   |         |            |
|Harmony Connector|     |✓    |   |✓       |        |     |✓    |        |✓  |   |         |            |
|Harmony PDP AP   |     |✓    |   |        |✓       |✓    |     |        |   |   |         |            |
|Harmony E AP     |     |     |   |        |        |     |     |        |   |   |         |            |
|Harmony GCN AP   |     |     |✓  |        |✓       |✓    |     |        |   |   |         |            |
|Phoss SMP        |     |     |✓  |        |        |     |     |        |   |   |         |            |
|TDX v5           |     |     |   |        |        |     |     |        |   |✓  |         |            |
|TDX Infinity     |     |     |   |        |        |     |     |✓       |   |✓  |         |            |

## 2 : S3 bucket creation (Flashblade)

#### Expected inputs : 

  - ```${env}``` : environment in [UAT, PRE, PRD]
  - ```${flashblade_account}``` : TODO : retrouver regle de nomage  
  - ```${client_name}``` : the same as the one used in AIO instance

#### Actions to perform :

  - from git repo     : https://github.com/generix-group/genx-flashblade-cli
  - create file       : ```configs/environments/${env}/${flashblade_account}/${client_name}.yaml```
  - using format      : 
```
      environment: ${env}-${client_name}
      replication: true

      clients:
      - name: ${client_name}
        preset: standard    # ou 'minimal', 'with_archive', 'with_backup'

      shared_services: {}
      infrastructure_services: {}
```
  - commit the file to git repo
  - Post commit :
    - Verify successful execution of GitHub Action “Flashblade provisioning” at URL: https://github.com/generix-group/genx-flashblade-cli/actions
    - [optional] Verify in the FlashBlade UI that the bucket was successfully created at: https://inf-fblade-c-01.vmwr/

## 3 : Fill in the configuration files for the satellites to be deployed

#### Expected inputs : 

  - ```${ocp_cluster_env}``` : ocp cluster in [???, prd, etc ...] <- TODO: Vérifier le nom des clusters OCP 
  - ```${env}```             : environment in [UAT, PRE, PRD]
  - ```${pdp_name}```        : PDP name in [GNX, PITNEY, FULL, any MB] <- TODO: Vérifier le nom des PDPs 
  - ```${client_name}```     : the same as the one used in AIO instance
  - ```${client_short_name}=${client_name:0:10}``` <- TODO: check with DevOps
  - ```${satellite_name}```    : in [???, invoiceapiservice, etc ...] <- TODO: Vérifier le nom des satellites 
  - ```${satellite_short_name}=${satellite_name:0:10}```
  - ```${satellite_image_tag}``` : Ex: "2.3.3-RELEASE" <- TODO: Vérifier si le template ne devrait pas systématiquement contenir la last version ??? Peut etre pas si compat matrix inter apps ???

  - ```${ocp_ingress_fqdn}``` : in ["${ocp_ingress_fqdn}", ???] TODO: List FQDNs/${envs}
  - ```${s3_bay_fqdn}```      : in ["${s3_bay_fqdn}", ???] TODO: List FQDNs/${envs}
  - ```${kc_fqdn}```          : in ["${kc_fqdn}", ???] TODO: List FQDNs/${envs}
  - ```${kc_back_realm}```    : Ex: "${kc_back_realm}" TODO: What is this ???
  - ```${rabbitmq_fqdn}```    : in ["${rabbitmq_fqdn}", ???] TODO: List FQDNs/${envs)

### 3.1 : Fill in the global RabbitMQ configuration for the satellites to be deployed.

#### Actions to perform :

  - from git repo : https://github.com/generix-group/genx-gdp-prd-values-applications/
  - create file   : ```gis/${pdp_name}/clients/${client_name}/${env}/rabbit.yaml```
  - with format   : 
```
      namespace: rabbitmq-${ocp_cluster_env}
      cluster: rabbitmq-${ocp_cluster_env}

      env: ${env}

      clientName: ${client_name}
      clientShortName: ${client_short_name}

      applications:
        - applicationName: gisaio
          applicationShortName: gisaio
          exchanges:
            - exchangeVersion: v1
              type: headers
              vhost: ${env}-infrastructure
              arguments:
                - "x-match: all"
                - "alternate-exchange: ${env}-${client_name}-gisaio-router-exchange-alternate"
              queues:
                - name: "entities"
                  version: v1
                  arguments: 
                    - "x-dead-letter-exchange: ${env}-${client_name}-gisaio-entities-exchange-dlx"
            - exchangeVersion: dlx
              type: fanout
              vhost: ${env}-infrastructure
              queueRef: entities
              queues:
                - name: "entities"
                  version: dlq
                  bindings:
                  - version: v1
            - exchangeVersion: alternate
              type: fanout
              vhost: ${env}-infrastructure
              queues:
                - name: "router"
                  version: dlq
                  bindings: 
                  - version: v1
            - exchangeVersion: v1
              type: headers
              vhost: ${env}-invoicing
              arguments:
                - "x-match: all"
                - "alternate-exchange: ${env}-${client_name}-gisaio-router-exchange-alternate"
              queues:
                - name: "invoice"
                  version: v1
                  arguments: 
                    - "x-dead-letter-exchange: ${env}-${client_name}-gisaio-invoice-exchange-dlx"
                  bindings:
                    - version: v1
                      arguments:
                        - arg:
                            message-type: invoice.create
                    - version: v1
                      arguments:
                        - arg:
                            message-type: invoice.status
                - name: "process"
                  version: v1
                  arguments: 
                    - "x-dead-letter-exchange: ${env}-${client_name}-gisaio-process-exchange-dlx"
                  bindings:
                    - version: v1
                      arguments:
                        - arg:
                            message-type: process.execute
            - exchangeVersion: alternate
              type: fanout
              vhost: ${env}-invoicing
              queues:
                - name: "router"
                  version: dlq
                  bindings: 
                  - version: v1
            - exchangeVersion: dlx
              type: fanout
              vhost: ${env}-invoicing
              queueRef: process
              queues:
                - name: "process"
                  version: dlq
                  bindings:
                  - version: v1
            - exchangeVersion: dlx
              type: fanout
              vhost: ${env}-invoicing
              queueRef: invoice
              queues:
                - name: "invoice"
                  version: dlq
                  bindings:
                  - version: v1
          queues: []
          bindings: []
```
  - commit the file to git repo 

### 3.2 : Fill in the configuration for each satellite to be deployed

#### Actions to perform :

  - from git repo : https://github.com/generix-group/genx-gdp-prd-values-applications/
  - create file   : ```gis/${pdp_name}/clients/${client_name}/${env}/${satellite_name}/values.yaml```
  - with format   : 
```
      environment: ${env}
      clientName: ${client_name}
      clientShortName: ${client_name}
      applicationName: ${satellite_name}
      applicationShortName: ${satellite_short_name}
      teamName: gis

      namespace: gnx-gis-${client_name}-${env}

      image:
        registry: dgs-nexus-eqx.generixgroup.com
        repository: api-service/release/invoice-processing
        tag: ${satellite_image_tag}

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: gis${satellite_short_name}-${env}-${client_name}
                topologyKey: kubernetes.io/hostname
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: generixgroup.com/pool
                operator: In
                values:
                - preprod

      vaultSecret:
        enabled: true
        certificates: []

      launchOption:
        appType: "java"
        appOpts: "-XX:+ExitOnOutOfMemoryError -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/usr/data/oom/oom.hprof -XX:+UseParallelGC"

      certificates:
        - configMapName: "cluster-trusted-ca"
          type: "pem"
          certKey: "ca-bundle.crt"

      route:
        enabled: true
        environmentTarget: prd
        annotations:
          haproxy.router.openshift.io/timeout: 35s
          haproxy.router.openshift.io/rate-limit-connections: "100"
          haproxy.router.openshift.io/rate-limit-connections.concurrent-tcp: "50"
          haproxy.router.openshift.io/rate-limit-connections.rate-tcp: "100"
        componentName: "invoice-processing"
        targetPort: 8080
        tls:
          enabled: true
          termination: edge
          insecureEdgeTerminationPolicy: Redirect
        wildcardPolicy: None

      deploymentAsCron:
        enabled: false

      securityContext:
        container:
          enabled: true
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          capabilities:
            drop:
              - ALL

      replicas: 1

      env:
        ENABLED_SECURITY: "true"
        BASE_PATH: "/${client_name}/invoice-processing"
        CALLBACK_API_URL: "https://${ocp_ingress_fqdn}/gnx/webhookcallback"
        MINIO_URL: "https://${s3_bay_fqdn}"
        MINIO_BUCKET: "${env}-${satellite_short_name}-${client_name}"
        MINIO_SECURE: "true"
        SPRING_PROFILES_ACTIVE: ""
        KEYCLOAK_AUTH_SERVER_URL: "https://${kc_fqdn}/auth"
        KEYCLOAK_REALM: ${kc_back_realm}
        RABBITMQ_HOST: "${rabbitmq_fqdn}"
        RABBITMQ_VHOST: "/${env}-invoicing"
        BROKER_EXCHANGE: "${env}-${client_name}-gisaio-router-exchange-v1"
        RABBITMQ_PORT: 5672
        INVOICE_MAX_SIZE: 10000KB
        ATTACHMENTS_MAX_FILES: 10
        ATTACHMENTS_MAX_SIZE: 20000KB
        
      secrets:
        MINIO_ACCESS_KEY: MINIO_ACCESS_KEY
        MINIO_SECRET_KEY: MINIO_SECRET_KEY
        RABBITMQ_USERNAME: RABBITMQ_USERNAME
        RABBITMQ_PASSWORD: RABBITMQ_PASSWORD

      containerPorts:
        - 8080
        - 8443
        - 5005
        - 35729

      resources:
        requests:
          memory: "512Mi"
          cpu: "250m"
        limits:
          memory: "1Gi"
          cpu: "1000m"

      readinessProbe:
        httpGet:
          path: /${client_name}/invoice-processing/actuator/health/readiness
          port: 8080
          scheme: HTTP
        initialDelaySeconds: 60
        periodSeconds: 20
        timeoutSeconds: 10

      livenessProbe:
        httpGet:
          path: /${client_name}/invoice-processing/actuator/health/liveness
          port: 8080
          scheme: HTTP
        initialDelaySeconds: 90
        periodSeconds: 30

      service:
        type: ClusterIP
        service:
          - protocol: TCP
            name: http
            port: 8080
            targetPort: 8080
          - protocol: TCP
            name: https
            port: 8443
            targetPort: 8443
          - protocol: TCP
            name: debug
            port: 5005
            targetPort: 5005
          - protocol: TCP
            name: livereload
            port: 35729
            targetPort:

      #autoscaling:

      metrics:
        enabled: false
        serviceMonitor: true

      rabbitmq:
        enabled: true
        clusterReference: rabbitmq-${ocp_cluster_env}
        namespace: rabbitmq-${ocp_cluster_env}
        user:
          create: true
          permissions:
            - vhost: ${env}-invoicing
              write: '^${env}-${client_name}-gisaio-router-exchange-v([1-9][0-9]?)$'
          extras:
            - keyUsername: RABBITMQ_USERNAME_GISAIO
              keyPassword: RABBITMQ_PASSWORD_GISAIO
              permissions:
                - vhost: ${env}-invoicing
                  write: '^${env}-${client_name}-gisaio-router-exchange-v([1-9][0-9]?)$'
                  configure: "^$"
                  read: '^(${env}-${client_name}-gisaio-process-queue-v([1-9][0-9]?)|${env}-${client_name}-gisaio-invoice-queue-v([1-9][0-9]?))$'
                - vhost: ${env}-infrastructure
                  write: '^${env}-${client_name}-gisaio-router-exchange-v([1-9][0-9]?)$'
                  configure: "^$" 
                  read: '^${env}-${client_name}-gisaio-entities-queue-v([1-9][0-9]?)$'

      serviceAccount:
        create: true
```
  - commit the file to git repo 

## 4 : Create the secrets required by previously created values.yaml files

#### INFO : Create the secrets for each entry under ```secrets:``` in every values.yaml file that was created or modified

  - S3:FlashBlade secrets were created by the GitHub Action “Flashblade provisioning” and values are available
    - from URL : http://vault-console.apps.npr.openshift.vmwr
    - at path  : Secrets / generix / flashblade / ```${env}``` / acc-ocp-```${env}```-gnx / ```${client_name}``` / ```${env}```-```${satellite_name}```-```${client_name}```
    - keys     : 
      - access_key_id
      - secret_access_key  
    - Ex : secrets:
            MINIO_ACCESS_KEY: MINIO_ACCESS_KEY
            MINIO_SECRET_KEY: MINIO_SECRET_KEY
  - All other secret values must be manually generated in Vault, in compliance with the password complexity rules 
    - Ex : secrets:
            RABBITMQ_USERNAME: RABBITMQ_USERNAME
            RABBITMQ_PASSWORD: RABBITMQ_PASSWORD
    - Ex : extras:
            - keyUsername: RABBITMQ_USERNAME_GISAIO
              keyPassword: RABBITMQ_PASSWORD_GISAIO

#### Expected inputs : 

  - ```${env}```              : environment in [UAT, PRE, PRD]
  - ```${satellite_name}```   : in [???, invoiceapiservice, etc ...] <- TODO: Vérifier le nom des satellites 
  - ```${client_name}```      : the same as the one used in AIO instance
  - ```${secret_name}```  x N : the N secret names found in the values.yaml files
  - ```${secret_value}``` x N : the N secret values to create 

#### Actions to perform:

  - from Vault URL : https://vault-console.apps.prd.openshift.vmwr/ui/vault/
  - at path        : Secrets Engines > generix   
  - create secrets : (do once per secret / extra present in values.yaml) :
    - Path for this secret : ```gis/${client_name}/${satellite_name}/${env}```
    - Secret data key   : ${secret_name}  ; Ex: MINIO_SECRET_KEY
    - Secret data value : ${secret_value} ; Ex: #lJyU78-43_*T5JsHHk
  - Create the RabbitMQ access secrets for the other applications (Ex: AIO) :
    - Path for this secret : ```gis/${client_name}/${satellite_name}/${env}-ext-apps```
    - Secret data key   : ${secret_name}  ; Ex pour RABBITMQ_USERNAME : with format ```${env}-${client_name}-gisaio```
    - Secret data value : ${secret_value} ; Ex: #kOtU99-43_%K2lZJJm

## 5 : Authorize access to Vault secrets for the satellites to be deployed 

#### Expected inputs : 

  - ```${env}```              : environment in [UAT, PRE, PRD]
  - ```${satellite_name}```   : in [???, invoiceapiservice, etc ...] <- TODO: Vérifier le nom des satellites 
  - ```${client_name}```      : the same as the one used in AIO instance

#### Actions to perform :

  - from git repo : https://github.com/generix-group/genx-gpe-prd-platform-vault
  - at path       : ```vault/apps-registry/generix/gis/${client_name}/${satellite_name}```
    - create file : ${env}.yaml 
    - with format :
```
        app:
          # Path components (mirrors Vault secret path)
          engine: generix
          product: gis
          client: ${client_name}
          service: ${satellite_name}
          environment: ${env}

          # Role configuration
          permission: reader
          ttl: 24h
          policies:
            - default

          # Kubernetes bindings for this environment
          namespaces:
            - gnx-gis-${client_name}-${env}

          serviceAccounts:
            - ${satellite_name}-${env}-${client_name}-sa      
```
  - at path.      : ```vault/apps-registry/kustomization.yaml```
    - add line    : ```${client_name}-${satellite_name}-${env}.yaml=generix/gis/${client_name}/${satellite_name}/${env}.yaml```
  - commit the file to git repo 

## 6 : Define the new desired state in OCP

#### INFO : Udating this file will trigger a new ArgoCD reconciliation job to propagate all changes to OCP 

#### Expected inputs : 

  - ```${env}```            : environment in [UAT, PRE, PRD]
  - ```${pdp_name}```       : PDP name in [GNX, PITNEY, FULL, any MB] <- TODO: Vérifier le nom des PDPs 
  - ```${client_name}```    : 
  - ```${satellite_name}``` : in [???, invoiceapiservice, etc ...] <- TODO: Vérifier le nom des satellites 
  - ```${${satellite_name}-chart-version}``` : Ex: "0.3.88"
  - ```${rabbitmq-chart-version}```          : Ex: "0.3.9"

#### Actions to perform :

  - from git repo : https://github.com/generix-group/genx-gdp-prd-gitops
  - at path       : ```apps/gis/${pdp_name}/${env}/values.yaml```
  - Add the desired service entries in the following format : 
```
      - name: ${client_name}
        applications:
          - name: ${satellite_name}
            chartVersion: "${${satellite_name}-chart-version}"
        rabbit:
          chartVersion: "${rabbitmq-chart-version}"
```
  - commit the file to git repo 

## 7 : Check ArgoCD deployement 

  - from argocd web interface : https://openshift-gitops-server-openshift-gitops.apps.prd.openshift.vmwr/
  - Check that the deployed services turn green

## 8 : [optional] Check rabbitmq objets are created 

  - from rabbitmq web interface : https://rabbitmq.apps.prd.openshift.vmwr
  - check all objects defined in {rabbitmq,values}.yaml exist

## 9 : [info] Miscellaneous 

### Available R&D documentations : 

  - General CD step-by-step guide : https://confluence.generixgroup.com/pages/viewpage.action?spaceKey=GPE&title=General+CD+step-by-step+guide
  - Satellites pre requisits : https://confluence.generixgroup.com/pages/viewpage.action?spaceKey=GPE&title=GIS
  - Naming GUIDE – AIO & Satellites 5.96 : https://confluence.generixgroup.com/pages/viewpage.action?pageId=241345003

### Middlewares web interfaces : 

  - S3:Flashblade : https://inf-fblade-c-01.vmwr/
  - PRD:RabbitMQ  : https://rabbitmq.apps.prd.openshift.vmwr/
  - PRD:ArgoCD    : https://openshift-gitops-server-openshift-gitops.apps.prd.openshift.vmwr/
  - PRD:Vault     : https://vault-console.apps.prd.openshift.vmwr/    <- use OIDC + role generix-admin
  - NPD:Vault     : https://vault-console.apps.npr.openshift.vmwr/    <- use OIDC + role gis-admin
