<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grapher — Highcharts Stock + Framework7 Sheet</title>

<!-- Highcharts Stock -->
<script src="https://code.highcharts.com/stock/highstock.js"></script>

<!-- Framework7 (bundle) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8.3.4/framework7-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/framework7@8.3.4/framework7-bundle.min.js"></script>

<style>
  :root{
    --bg:#0b0c0f; --fg:#e5e7eb; --panel:#12141a; --muted:#9aa3af; --border:#1f2430; --accent:#7c5cff;
  }
  [data-theme="light"]{
    --bg:#f7f7fb; --fg:#0f172a; --panel:#ffffff; --muted:#4b5563; --border:#e7e7ef; --accent:#6d28d9;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}

  /* Chart full width, sticky */
  #chartWrap{position:sticky;top:0;z-index:5;background:var(--bg);border-bottom:1px solid var(--border)}
  #chart{width:100%;height:65vh;min-height:320px}

  /* Bouton discret pour ouvrir la sheet */
  .controls-opener{
    position:fixed; right:16px; bottom:16px; z-index:20;
    background:var(--accent); color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer;
    box-shadow:0 6px 20px rgba(0,0,0,.25);
  }

  /* Form look */
  .muted{color:var(--muted)}
  textarea, input[type="text"], select, button{
    background:transparent;border:1px solid var(--border);color:var(--fg);padding:8px;border-radius:8px
  }
  textarea{min-height:120px;resize:vertical}
  .series-row{display:grid;grid-template-columns:1fr 160px 100px;gap:8px;align-items:center}
</style>
</head>
<body data-theme="dark">
<div id="app"><!-- F7 root -->

  <!-- CHART -->
  <div id="chartWrap"><div id="chart"></div></div>

  <!-- OUVERTURE SHEET via JS (pas de .fab ni .sheet-open auto) -->
  <button id="openControls" class="controls-opener">Contrôles</button>

  <!-- SHEET MODAL, conforme à la doc -->
  <div id="controls-sheet"
       class="sheet-modal sheet-modal-push"
       style="height:auto"
       data-backdrop="true"
       data-swipe-to-close="true"
       data-push="true"
       data-breakpoints='[0.2,0.5,0.9,1]'
       data-backdrop-breakpoint="0.2"
       data-push-breakpoint="0.5">
    <!-- Sheet Inner -->
    <div class="sheet-modal-inner">
      <!-- Contenu scrollable : OBLIGATOIRE -->
      <div class="page-content">
        <!-- Toolbar optionnelle en haut de sheet -->
        <div class="toolbar">
          <div class="toolbar-inner">
            <div class="left"><span class="muted">Contrôles</span></div>
            <div class="right"><a href="#" class="link sheet-close">Fermer</a></div>
          </div>
        </div>

        <div class="block">
          <div class="block-title">Importer / Coller des données</div>
          <div class="list no-hairlines-md">
            <ul>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Fichier JSON</div>
                  <div class="item-input-wrap"><input type="file" id="fileInput" accept="application/json,.json,.txt"></div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Nom par défaut d’une série (si absent)</div>
                  <div class="item-input-wrap"><input id="defaultSeriesName" type="text" placeholder="series"></div>
                </div>
              </li>
              <li class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">JSON</div>
                  <div class="item-input-wrap">
                    <textarea id="jsonInput" placeholder='Formats:
- Map: { "http-2xx":[[ts,val],...], "http-5xx":[...], ... }
- Array: [ {"name":"http-2xx","data":[[ts,val],...]}, ... ]
- Single: [[ts,val],...]  ou  [{"timestamp":"...","value":123}, ...]'></textarea>
                  </div>
                </div>
              </li>
            </ul>
          </div>
          <div class="row padding-horizontal">
            <a class="button button-fill" id="btnReplace">Charger (Remplace)</a>
            <a class="button" id="btnAdd">Ajouter</a>
            <a class="button button-outline color-red" id="btnClear">Vider</a>
          </div>
          <div id="status" class="padding muted"></div>

          <div class="block-title">Séries (type par série)</div>
          <div id="seriesControls" class="list simple-list"></div>

          <div class="block-title">Données (localStorage)</div>
          <div class="row padding-horizontal">
            <a class="button" id="btnExport">Exporter</a>
            <a class="button" id="btnImport">Importer</a>
            <a class="button button-outline color-red" id="btnClearAll">Tout supprimer</a>
            <input id="importAllInput" type="file" accept="application/json" style="display:none" />
          </div>
          <div class="padding muted">Persisté dans votre navigateur.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ====== Framework7, création explicite de la sheet ====== */
// Doc: structure .sheet-modal / .sheet-modal-inner + page-content ; params swipeToClose / breakpoints / push.  [oai_citation:1‡Framework7](https://framework7.io/docs/sheet-modal)
const app = new Framework7({ el: '#app', theme: 'auto', sheet:{ closeByBackdropClick:true } });
const sheet = app.sheet.create({ el: '#controls-sheet' });

// Ouverture contrôlée: on ouvre puis on place directement au breakpoint 0.5
document.getElementById('openControls').addEventListener('click', () => {
  sheet.open();
  sheet.setBreakpoint(0.5); // API officielle pour viser un breakpoint précis.  [oai_citation:2‡Framework7](https://framework7.io/docs/sheet-modal)
});

/* ====== Highcharts Stock ====== */
const TYPE_OPTIONS = ['spline','line','area','areaspline','column','column-stacked'];
const DATA_KEY = 'ts_data_v4';
const $ = (id)=>document.getElementById(id);

const yAxisForType = (t)=> (t==='column'||t==='column-stacked') ? 0 : 1; // TA RÈGLE
const normalizeType = (t)=> (t==='column-stacked') ? {actual:'column', stacked:true} : {actual:(t||'spline'), stacked:false};
const anyStacked = (list)=> list.some(s => s.type==='column-stacked');

const toMillis = (ts) => (typeof ts==='number') ? ts : (Number(ts)>1e10 ? Number(ts) : Date.parse(ts));
function normalizeDataArray(arr){
  if(!Array.isArray(arr)) throw new Error('Une série doit être un tableau');
  if(!arr.length) return [];
  if(Array.isArray(arr[0])) return arr.map(p=>[toMillis(p[0]), Number(p[1])]);
  return arr.map(p=>[toMillis(p.timestamp ?? p.time ?? p.t), Number(p.value ?? p.v)]);
}
function parseJson(text, defaultName='series'){
  const obj = JSON.parse(text);
  if(obj && typeof obj==='object' && !Array.isArray(obj)){
    return Object.entries(obj).map(([name,data])=>({ name, data: normalizeDataArray(data) }));
  }
  if(Array.isArray(obj)){
    if(obj.length && typeof obj[0]==='object' && !Array.isArray(obj[0]) && ('name' in obj[0] || 'data' in obj[0])){
      return obj.map((s,i)=>({ name: s.name ?? `${defaultName} ${i+1}`, data: normalizeDataArray(s.data ?? s.values ?? s.series ?? []) }));
    }
    return [{ name: defaultName, data: normalizeDataArray(obj) }];
  }
  throw new Error('Format JSON non supporté');
}

/* Démo 7j x 1min si aucune donnée */
function generateDemoData(){
  const now = new Date(); now.setSeconds(0,0);
  const end = new Date(now.getTime() - 60*1000);
  const points = 7*24*60;
  const start = new Date(end.getTime() - (points-1)*60*1000);
  const hourMult=[0.25,0.20,0.18,0.18,0.20,0.30,0.45,0.60,0.80,0.95,1.00,1.05,1.10,1.10,1.05,1.00,0.95,0.90,0.85,0.80,0.70,0.55,0.40,0.30];
  const s2=[],s3=[],s5=[],srt=[]; const spikes=new Set();
  for(let d=0; d<7; d++){ const off=d*1440; const n=2+Math.floor(Math.random()*3); for(let k=0;k<n;k++) spikes.add(off+Math.floor(Math.random()*1440)); }
  for(let i=0;i<points;i++){
    const t=new Date(start.getTime()+i*60*1000); const ts=t.getTime(); let mult=hourMult[t.getHours()]; if(t.getDay()===0||t.getDay()===6) mult*=0.75;
    const v2=Math.max(0,Math.round(120*mult + (Math.random()*0.2-0.1)*120*mult));
    const v3=Math.max(0,Math.round(v2*(0.02+Math.random()*0.04)));
    let v5=Math.random()<0.85?0:1; if(spikes.has(i)) v5+=5+Math.floor(Math.random()*16);
    const vrt=Math.max(50,Math.round(120+80*mult+(spikes.has(i)?(40+Math.random()*80):0)+(Math.random()*24-12)));
    s2.push([ts,v2]); s3.push([ts,v3]); s5.push([ts,v5]); srt.push([ts,vrt]);
  }
  return [
    { name:'http-2xx', type:'column-stacked', data:s2 },
    { name:'http-3xx', type:'column-stacked', data:s3 },
    { name:'http-5xx', type:'column-stacked', data:s5 },
    { name:'response_time_ms', type:'spline', data:srt }
  ];
}

/* Persist */
let storedData=[];
function loadData(){ try{ storedData = JSON.parse(localStorage.getItem(DATA_KEY) || '[]'); }catch{ storedData=[]; } }
function saveData(){ localStorage.setItem(DATA_KEY, JSON.stringify(storedData)); }

/* Chart */
let chart;
const GROUP_UNITS = [['minute',[1,5,10,15,30]],['hour',[1,6,12]],['day',[1,7]]];
function buildSeriesConfig(s){
  const {actual} = normalizeType(s.type);
  const approx = /^http-\dxx$/i.test(s.name) ? 'sum' : 'average';
  return { name:s.name, type:actual, yAxis:yAxisForType(s.type), data:s.data,
           dataGrouping:{enabled:true, units:GROUP_UNITS, approximation:approx} };
}
function renderChart(){
  const stacked = anyStacked(storedData) ? 'normal' : null;
  chart = Highcharts.stockChart('chart',{
    chart:{ backgroundColor:'transparent' },
    title:{ text:'' }, credits:{enabled:false},
    rangeSelector:{ selected:1, inputEnabled:false },
    tooltip:{ shared:true, split:false },
    xAxis:{ type:'datetime' },
    yAxis:[ { title:{text:'Colonnes'} }, { title:{text:'Lignes/Aires'}, opposite:true } ],
    plotOptions:{
      series:{ turboThreshold:0, animation:false },
      column:{ stacking:stacked, borderWidth:0, pointPadding:0.05, groupPadding:0.08 }
    },
    series: storedData.map(buildSeriesConfig)
  });
  refreshSeriesControls();
}

/* UI: séries */
function refreshSeriesControls(){
  const box = document.getElementById('seriesControls'); box.innerHTML='';
  if(!storedData.length){ box.innerHTML='<div class="muted padding">Aucune série.</div>'; return; }
  storedData.forEach((s, idx)=>{
    const row=document.createElement('div'); row.className='series-row';
    const name=document.createElement('div'); name.textContent=s.name;

    const sel=document.createElement('select');
    ['spline','line','area','areaspline','column','column-stacked'].forEach(t=>{
      const o=document.createElement('option'); o.value=t; o.textContent=t; if(s.type===t) o.selected=true; sel.appendChild(o);
    });
    sel.addEventListener('change', ()=>{ s.type = sel.value; saveData(); renderChart(); });

    const btn=document.createElement('button'); btn.textContent='Supprimer';
    btn.addEventListener('click', ()=>{ storedData.splice(idx,1); saveData(); renderChart(); });

    row.append(name, sel, btn); box.appendChild(row);
  });
}

/* Actions */
document.getElementById('btnReplace').addEventListener('click', ()=>{
  try{
    const def = document.getElementById('defaultSeriesName').value.trim() || 'series';
    const parsed = parseJson(document.getElementById('jsonInput').value, def).map(s=>({ name:s.name, type: guessType(s.name), data:s.data }));
    storedData = parsed; saveData(); renderChart();
    document.getElementById('status').textContent = `Remplacé: ${parsed.length} série(s).`;
  }catch(e){ document.getElementById('status').textContent = e.message; }
});
document.getElementById('btnAdd').addEventListener('click', ()=>{
  try{
    const def = document.getElementById('defaultSeriesName').value.trim() || 'series';
    const parsed = parseJson(document.getElementById('jsonInput').value, def).map(s=>({ name:s.name, type: guessType(s.name), data:s.data }));
    storedData.push(...parsed); saveData(); renderChart();
    document.getElementById('status').textContent = `Ajouté: ${parsed.length} série(s).`;
  }catch(e){ document.getElementById('status').textContent = e.message; }
});
document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('jsonInput').value=''; document.getElementById('status').textContent=''; });
document.getElementById('fileInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const text=await f.text(); document.getElementById('jsonInput').value=text; document.getElementById('status').textContent='Fichier chargé dans la zone JSON.'; }
  catch{ document.getElementById('status').textContent='Lecture de fichier impossible.'; }
});

/* Export / Import / Reset */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(storedData,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='time_series.json'; a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('btnImport').addEventListener('click', ()=>document.getElementById('importAllInput').click());
document.getElementById('importAllInput').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const def = document.getElementById('defaultSeriesName').value.trim() || 'series';
    const text = await f.text();
    const parsed = parseJson(text, def).map(s=>({ name:s.name, type: guessType(s.name), data:s.data }));
    storedData = parsed; saveData(); renderChart();
  }catch(err){ app.dialog.alert('Import échoué: '+err.message); }
  finally{ e.target.value=''; }
});
document.getElementById('btnClearAll').addEventListener('click', ()=>{
  app.dialog.confirm('Supprimer TOUTES les données ?','Confirmer', ()=>{
    localStorage.removeItem(DATA_KEY); storedData=[]; renderChart();
  });
});

/* Helpers */
const guessType = (name)=>{
  if(/^http-\dxx$/i.test(name)) return 'column-stacked';
  if(/(time|latency|ms)/i.test(name)) return 'spline';
  return 'spline';
};

/* Boot */
(function init(){
  loadData();
  if(!storedData.length){ storedData = generateDemoData(); saveData(); }
  renderChart();
})();
</script>
</body>
</html>
