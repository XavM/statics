<!-- Framework7 (CSS + JS) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/framework7@8.3.4/framework7-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/framework7@8.3.4/framework7-bundle.min.js"></script>

<!-- SHEET qui contiendra les contrôles -->
<style>
  #controls-sheet { height: auto; }
  #controls-sheet .sheet-modal-swipe-step { min-height: 84px; }
  .sheet-handle { height:20px; display:flex; align-items:center; justify-content:center; }
  .sheet-handle::before { content:""; width:36px; height:4px; border-radius:2px; background:#999; opacity:.6; }
</style>

<div class="sheet-modal sheet-modal-push" id="controls-sheet" style="display:none">
  <div class="sheet-handle"></div>
  <div class="sheet-modal-inner">
    <div class="sheet-modal-swipe-step">
      <div class="block no-margin">
        <p class="no-margin text-color-gray">Contrôles — swipe/tap pour agrandir ⤴︎</p>
      </div>
    </div>
    <div class="block" id="controls-target"></div>
  </div>
</div>

<script>
(function(){
  // 1) Boot Framework7 (sans rien casser de ta page)
  const app = new Framework7({ el: document.body, on:{ init: function(){
    // 2) Trouver le conteneur du graphique
    //    - priorité: parent de .highcharts-container (graph déjà initialisé)
    //    - fallback: #container ou #chart-container si présents
    let chartRoot = document.querySelector('.highcharts-container')?.parentElement
                 || document.getElementById('container')
                 || document.getElementById('chart-container');

    if (!chartRoot) {
      console.warn('[sheet patch] Graph container not found. Leaving DOM as-is.');
      return;
    }

    // 3) Créer la sheet (push + 2 steps ; drag sur toute la sheet)
    const sheetEl = document.getElementById('controls-sheet');
    sheetEl.style.display = ''; // rends la sheet visible
    const sheet = this.sheet.create({
      el: '#controls-sheet',
      swipeToStep: true,
      swipeToClose: false,
      push: true,
      backdrop: true
      // pas de swipeHandler => on peut swiper n'importe où
    });

    // 4) Déplacer les CONTRÔLES dans la sheet
    //    Heuristique :
    //      - on prend les frères (siblings) de chartRoot
    //      - et, à l'intérieur de chartRoot, on prend tout ce qui n'est PAS .highcharts-container
    //    => tout ça va dans #controls-target
    const target = document.getElementById('controls-target');
    const toMove = [];

    // frères du graphe (mêmes parents)
    Array.from(chartRoot.parentElement.children).forEach(el => {
      if (el === chartRoot) return;
      toMove.push(el);
    });

    // éléments internes au chartRoot qui ne sont pas le canvas Highcharts
    Array.from(chartRoot.children).forEach(el => {
      if (el.classList.contains('highcharts-container')) return;
      toMove.push(el);
    });

    // Évite de déplacer des éléments critiques (ex: <script>, <style>)
    const safeMove = el =>
      !(el.tagName === 'SCRIPT' || el.tagName === 'STYLE' || el.id === 'controls-sheet');

    toMove.filter(safeMove).forEach(el => target.appendChild(el));

    // 5) Ouvrir la sheet en compact par défaut
    sheet.open(false);
    sheet.stepClose(false);

    // 6) Tap-to-toggle + reflow du chart quand la taille change
    sheetEl.addEventListener('click', (e) => {
      if (e.target.closest('a,button,select,input,textarea,label')) return;
      sheet.stepOpened ? sheet.stepClose() : sheet.stepOpen();
      // reflow du graphe si Highcharts est chargé
      try {
        // Tente de retrouver l'instance Highcharts par son container
        const chartDiv = chartRoot.querySelector('.highcharts-container') || chartRoot;
        if (window.Highcharts && chartDiv) {
          const charts = Highcharts.charts || [];
          charts.forEach(c => { if (c && c.renderTo && c.renderTo.contains(chartDiv)) c.reflow(); });
        }
      } catch(e){}
    });
    sheet.on('stepOpen', () => { try{ (Highcharts.charts||[]).forEach(c=>c&&c.reflow()); }catch(e){} });
    sheet.on('stepClose', () => { try{ (Highcharts.charts||[]).forEach(c=>c&&c.reflow()); }catch(e){} });
    window.addEventListener('resize', () => { try{ (Highcharts.charts||[]).forEach(c=>c&&c.reflow()); }catch(e){} }, { passive:true });
  }}});

  // 7) Si tu veux un bouton pour ouvrir/fermer, tu peux en ajouter un n'importe où :
  //    <a href="#" id="openControls">Contrôles</a>
  document.addEventListener('click', function(e){
    const t = e.target.closest('#openControls');
    if (!t) return;
    e.preventDefault();
    const s = app.sheet.get('#controls-sheet');
    s ? s.open() : null;
  });
})();
</script>
